<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="theme-color" content="#05070d" />
    <title>BestShot</title>
    <link rel="manifest" href="/manifest.json" />
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <!-- Brand section above shell -->
    <div class="app-header">
      <div class="brand">
        <h1>BestShot</h1>
      </div>
      <div class="app-header-right">
        <div class="dropdown-control">
          <button id="settings-btn" class="icon-button" title="Settings">
            <span class="icon-gear">‚öô</span>
          </button>
          <div id="settings-dropdown" class="dropdown-menu dropdown-menu--right" hidden>
            <div class="dropdown-header">Display</div>
            <div class="dropdown-section">
              <span class="dropdown-label">Media type</span>
              <div class="media-filter" role="group" aria-label="Media filter">
                <button class="toggle active" data-media-filter="all">All</button>
                <button class="toggle" data-media-filter="photos">Photos</button>
                <button class="toggle" data-media-filter="videos">Videos</button>
              </div>
            </div>
            <div class="dropdown-section">
              <span class="dropdown-label">Grid size</span>
              <div class="grid-size-control" role="group" aria-label="Grid size">
                <button class="toggle" data-grid-size="small" title="Small thumbnails">S</button>
                <button class="toggle active" data-grid-size="medium" title="Medium thumbnails">M</button>
                <button class="toggle" data-grid-size="large" title="Large thumbnails">L</button>
              </div>
            </div>
            <div class="dropdown-divider"></div>
            <button id="theme-toggle-btn">
              <span class="dropdown-icon" id="theme-icon">üåô</span>
              <span id="theme-label">Dark mode</span>
            </button>
            <button id="shortcuts-btn">
              <span class="dropdown-icon">‚å®</span>
              Keyboard shortcuts
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Action buttons above panels -->
    <div class="top-actions">
      <div class="search-box">
        <input type="text" id="search-input" placeholder="Search by name or tag..." autocomplete="off" />
        <button id="clear-search" class="search-clear" hidden aria-label="Clear search">&times;</button>
      </div>
      <button id="start-compare" class="ghost">Compare</button>
      <div class="sort-control">
        <button id="sort-button" class="sort-button">
          <span id="sort-label">Rank</span>
          <span class="sort-button__icon">‚ñº</span>
        </button>
        <div id="sort-dropdown" class="sort-dropdown" hidden>
          <button data-sort="rank" class="active">Rank</button>
          <button data-sort="name">Name (A-Z)</button>
          <button data-sort="name_desc">Name (Z-A)</button>
          <button data-sort="date_desc">Date (Newest)</button>
          <button data-sort="date">Date (Oldest)</button>
          <button data-sort="size_desc">Size (Largest)</button>
          <button data-sort="size">Size (Smallest)</button>
        </div>
      </div>
    </div>

    <div class="shell">
      <!-- Mobile Album Selector -->
      <div class="mobile-project-bar">
        <button id="mobile-project-toggle" class="mobile-project-toggle">
          <span class="mobile-project-toggle__label">
            <span class="mobile-project-toggle__icon">üìÅ</span>
            <span id="mobile-project-name">Select album</span>
          </span>
          <span class="mobile-project-toggle__arrow">‚ñº</span>
        </button>
      </div>

      <aside class="panel panel--left" id="projects-panel">
        <div class="panel--left__header mobile-only">
          <h2>Albums</h2>
          <div class="panel--left__header-actions">
            <button id="refresh-projects-mobile" class="text-button" aria-label="Reload albums">‚Ü∫</button>
            <button id="close-projects-panel" class="panel-close-btn" aria-label="Close">√ó</button>
          </div>
        </div>
        <div class="panel-section">
          <div class="panel-head desktop-only">
            <h2>Albums</h2>
            <button id="refresh-projects" class="text-button" aria-label="Reload albums">
              ‚Ü∫ refresh
            </button>
          </div>
          <div id="all-projects-option" class="all-projects-option">
            <h3>All Albums</h3>
            <small>View all media</small>
          </div>
          <ul id="projects-list" class="projects"></ul>
        </div>
        <form id="new-project-form" class="panel-form">
          <label for="project-name">Create album</label>
          <input
            type="text"
            id="project-name"
            name="project-name"
            placeholder="night-run-01"
            autocomplete="off"
            required
          />
          <textarea
            id="project-description-input"
            name="project-description"
            placeholder='Optional note (e.g. "Portrait set B")'
            rows="2"
          ></textarea>
          <button type="submit" class="primary">Create Album</button>
        </form>
      </aside>
      
      <!-- Mobile backdrop for projects panel -->
      <div id="projects-panel-backdrop" class="projects-panel-backdrop" hidden></div>

      <section class="panel panel--right">
        <header class="workspace-header">
          <div>
            <p class="eyebrow">album</p>
            <h2 id="workspace-title">Select an album</h2>
            <p id="workspace-meta" class="muted"></p>
          </div>
          <div class="workspace-actions">
            <div class="upload-actions">
              <input type="file" id="file-input" multiple hidden accept="image/jpeg,image/png,image/gif,image/bmp,image/tiff,image/webp,image/heic,video/mp4,video/quicktime,video/x-msvideo,video/x-matroska,video/webm,video/x-m4v,video/x-ms-wmv,video/x-flv,video/3gpp,.jpg,.jpeg,.png,.gif,.bmp,.tif,.tiff,.webp,.heic,.mp4,.mov,.avi,.mkv,.webm,.m4v,.wmv,.flv,.3gp" />
              <button id="browse-files" class="ghost" disabled>Upload</button>
              <button id="select-mode-btn" class="ghost" disabled title="Toggle selection mode">Select</button>
            </div>
            
            <!-- Album Settings Dropdown -->
            <div class="dropdown-control" id="project-settings-control" hidden>
              <button id="project-settings-btn" class="icon-button" title="Album settings">
                <span class="icon-dots">‚ãÆ</span>
              </button>
              <div id="project-settings-dropdown" class="dropdown-menu" hidden>
                <div class="dropdown-header">Album</div>
                <button id="edit-description-menu-btn">
                  <span class="dropdown-icon">‚úé</span>
                  Edit Description
                </button>
                <button id="rename-project-menu-btn">
                  <span class="dropdown-icon">‚úé</span>
                  Rename album
                </button>
                <button id="download-all" disabled>
                  <span class="dropdown-icon">‚Üì</span>
                  Download all files
                </button>
                <button id="export-btn" disabled>
                  <span class="dropdown-icon">üìã</span>
                  Export metadata...
                </button>
                <div class="dropdown-divider"></div>
                <button id="delete-project" class="dropdown-danger" disabled>
                  <span class="dropdown-icon">üóë</span>
                  Delete album
                </button>
              </div>
              <div id="export-dropdown" class="dropdown-menu dropdown-submenu" hidden>
                <button data-export="json">Export as JSON</button>
                <button data-export="csv">Export as CSV</button>
                <button id="export-back-btn" class="dropdown-back">‚Üê Back</button>
              </div>
            </div>
          </div>
        </header>

        <section class="project-note" id="project-note-section" hidden>
          <form id="project-description-form">
            <label for="project-description">Description</label>
            <textarea
              id="project-description"
              placeholder="Leave a short note for this set"
              rows="1"
              disabled
            ></textarea>
            <div class="note-actions">
              <button id="save-description" class="ghost" hidden>Save note</button>
            </div>
          </form>
        </section>

        <section class="canvas" id="gallery-drop-zone">
          <div id="drop-overlay" class="drop-overlay" hidden>
            <p id="drop-overlay-text">Drop files to add to gallery</p>
            <small id="drop-overlay-subtext">New items will be marked as "Unranked"</small>
          </div>
          <div id="images-grid" class="images-grid"></div>
        </section>
      </section>
    </div>

    <template id="image-card-template">
      <div class="image-card" draggable="true">
        <div class="image-card__head">
          <span class="rank-pill"></span>
          <span class="drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</span>
          <p class="filename"></p>
          <button class="download-media-btn" aria-label="Download photo" title="Download photo">‚Üì</button>
          <button class="delete-media-btn" aria-label="Delete photo" title="Delete photo">&times;</button>
        </div>
        <img alt="" loading="lazy" />
        <div class="image-card__tags">
          <div class="tags-list"></div>
          <div class="tag-input-wrapper" hidden>
            <input type="text" class="tag-input" placeholder="Add tag..." />
          </div>
          <button class="add-tag-btn" aria-label="Add tag">+ tag</button>
        </div>
      </div>
    </template>

    <template id="video-card-template">
      <div class="image-card video-card" draggable="true">
        <div class="image-card__head">
          <span class="rank-pill"></span>
          <span class="drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</span>
          <p class="filename"></p>
          <button class="download-media-btn" aria-label="Download video" title="Download video">‚Üì</button>
          <button class="delete-media-btn" aria-label="Delete video" title="Delete video">&times;</button>
        </div>
        <div class="video-thumbnail">
          <video muted preload="metadata"></video>
          <button class="play-button" aria-label="Play video">
            <svg viewBox="0 0 24 24" fill="currentColor" width="32" height="32">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </button>
        </div>
        <div class="image-card__tags">
          <div class="tags-list"></div>
          <div class="tag-input-wrapper" hidden>
            <input type="text" class="tag-input" placeholder="Add tag..." />
          </div>
          <button class="add-tag-btn" aria-label="Add tag">+ tag</button>
        </div>
      </div>
    </template>

    <!-- Video Player Modal -->
    <div id="video-modal" class="video-modal" hidden>
      <div class="video-modal__backdrop"></div>
      <div class="video-modal__content">
        <button class="video-modal__close" aria-label="Close video">&times;</button>
        <video id="modal-video" controls autoplay></video>
        <p id="modal-video-name" class="video-modal__name"></p>
      </div>
    </div>

    <!-- Fullscreen Media Viewer Modal (for Gallery mode) -->
    <div id="media-viewer-modal" class="media-viewer-modal" hidden>
      <div class="media-viewer-modal__backdrop"></div>
      <div class="media-viewer-modal__content">
        <button class="media-viewer-modal__close" aria-label="Close viewer">&times;</button>
        <button class="media-viewer-modal__nav media-viewer-modal__prev" aria-label="Previous">&#8249;</button>
        <button class="media-viewer-modal__nav media-viewer-modal__next" aria-label="Next">&#8250;</button>
        <div class="media-viewer-modal__media">
          <img id="viewer-image" alt="" />
          <video id="viewer-video" controls></video>
        </div>
        <div class="media-viewer-modal__info">
          <p id="viewer-filename" class="media-viewer-modal__name"></p>
          <div class="media-viewer-modal__actions">
            <div id="slideshow-controls" class="slideshow-controls" hidden>
              <button id="slideshow-toggle" class="ghost">‚ñ∂ Slideshow</button>
              <span id="slideshow-timer" class="slideshow-timer"></span>
            </div>
            <button id="viewer-download-btn" class="ghost viewer-download-btn">
              <span class="download-icon">‚Üì</span> Download
            </button>
          </div>
          <div class="media-viewer-modal__tags">
            <div id="viewer-tags-list" class="tags-list"></div>
            <div id="viewer-tag-input-wrapper" class="tag-input-wrapper" hidden>
              <input type="text" id="viewer-tag-input" class="tag-input" placeholder="Add tag..." />
            </div>
            <button id="viewer-add-tag-btn" class="add-tag-btn" aria-label="Add tag">+ tag</button>
          </div>
          <div id="viewer-comment" class="comment-field">
            <textarea id="viewer-comment-input" class="comment-input" placeholder="Add a note about this image..."></textarea>
          </div>
          <div id="viewer-exif-section" class="exif-section">
            <button id="viewer-exif-toggle" class="exif-toggle">
              <span class="exif-toggle__icon">üì∑</span>
              <span id="exif-toggle-label">Show camera info</span>
            </button>
            <div id="viewer-exif" class="exif-panel" hidden>
              <div id="exif-grid" class="exif-panel__grid"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Comparison Mode Selection Modal -->
    <div id="comparison-selection" class="comparison-selection" hidden>
      <div class="comparison-selection__backdrop"></div>
      <div class="comparison-selection__content">
        <h3>Start Comparison</h3>
        <p>Choose which items to compare and rank</p>
        <div class="comparison-selection__options">
          <button id="compare-all" class="comparison-option">
            <span class="comparison-option__title">All Items</span>
            <span id="compare-all-count" class="comparison-option__count">0 items</span>
            <span class="comparison-option__desc">Compare and rank all media in the gallery</span>
          </button>
          <button id="compare-unranked" class="comparison-option">
            <span class="comparison-option__title">New Items Only</span>
            <span id="compare-unranked-count" class="comparison-option__count">0 new items</span>
            <span class="comparison-option__desc">Compare new items against existing ranking to find their place</span>
          </button>
        </div>
        <div class="comparison-selection__actions">
          <button id="cancel-comparison-selection" class="ghost">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Comparison Mode UI -->
    <div id="comparison-mode" class="comparison-mode" hidden>
      <div class="comparison-mode__header">
        <h2>Ranking Mode</h2>
        <p id="comparison-progress" class="comparison-mode__progress">Comparison 1 of 10</p>
        <button id="exit-comparison" class="ghost">Exit</button>
      </div>
      <p class="comparison-mode__instruction">Click on the image you prefer</p>
      <div class="comparison-mode__arena">
        <div class="comparison-card" id="compare-left">
          <img alt="" />
          <video muted></video>
          <p class="comparison-card__name"></p>
        </div>
        <div class="comparison-vs">VS</div>
        <div class="comparison-card" id="compare-right">
          <img alt="" />
          <video muted></video>
          <p class="comparison-card__name"></p>
        </div>
      </div>
      <div class="comparison-mode__actions">
        <button id="comparison-skip" class="ghost">Skip (tie)</button>
      </div>
    </div>

    <!-- Comparison Results Modal -->
    <div id="comparison-results" class="comparison-results" hidden>
      <div class="comparison-results__backdrop"></div>
      <div class="comparison-results__content">
        <h2>Ranking Complete!</h2>
        <p class="comparison-results__subtitle">Your images ranked by preference</p>
        <div id="results-list" class="comparison-results__list"></div>
        <div class="comparison-results__actions">
          <button id="apply-ranking" class="primary">Apply Ranking</button>
          <button id="discard-ranking" class="ghost">Discard</button>
        </div>
      </div>
    </div>

    <!-- Rename Album Modal -->
    <div id="rename-modal" class="rename-modal" hidden>
      <div class="rename-modal__backdrop"></div>
      <div class="rename-modal__content">
        <h3>Rename Album</h3>
        <p>Enter a new name for <strong id="rename-project-current"></strong></p>
        <input type="text" id="rename-project-input" placeholder="New album name..." autocomplete="off" />
        <div class="rename-modal__actions">
          <button id="confirm-rename" class="primary">Rename</button>
          <button id="cancel-rename" class="ghost">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="delete-modal" class="delete-modal" hidden>
      <div class="delete-modal__backdrop"></div>
      <div class="delete-modal__content">
        <h3>Delete Album?</h3>
        <p>Are you sure you want to delete <strong id="delete-project-name"></strong>? This will remove all media files and cannot be undone.</p>
        <div class="delete-modal__actions">
          <button id="confirm-delete" class="primary danger">Delete</button>
          <button id="cancel-delete" class="ghost">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Album Selection Modal (for file drops in All Albums view) -->
    <div id="project-select-modal" class="project-select-modal" hidden>
      <div class="project-select-modal__backdrop"></div>
      <div class="project-select-modal__content">
        <h3>Choose an Album</h3>
        <p>Select which album to add these files to, or create a new album.</p>
        <div id="project-select-list" class="project-select-modal__list"></div>
        <div class="project-select-modal__divider">or create new</div>
        <div class="project-select-modal__new">
          <input type="text" id="project-select-new-name" placeholder="New album name..." />
          <button id="project-select-create" class="primary">Create</button>
        </div>
        <div class="project-select-modal__actions">
          <button id="project-select-cancel" class="ghost">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Upload Progress Indicator -->
    <div id="upload-progress" class="upload-progress" hidden>
      <div class="upload-progress__header">
        <p class="upload-progress__title">Uploading...</p>
        <span id="upload-progress-status" class="upload-progress__status">0%</span>
      </div>
      <div class="upload-progress__bar">
        <div id="upload-progress-fill" class="upload-progress__fill" style="width: 0%"></div>
      </div>
    </div>

    <!-- Bulk Actions Bar -->
    <div id="bulk-actions-bar" class="bulk-actions-bar" hidden>
      <span id="bulk-count" class="bulk-actions-bar__count">0 selected</span>
      <button id="bulk-tag-btn" class="ghost">Add Tag</button>
      <button id="bulk-download-btn" class="ghost">Download</button>
      <button id="bulk-delete-btn" class="ghost danger">Delete</button>
      <button id="bulk-cancel-btn" class="ghost">Cancel</button>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div id="shortcuts-modal" class="shortcuts-modal" hidden>
      <div class="shortcuts-modal__backdrop"></div>
      <div class="shortcuts-modal__content">
        <h3>Keyboard Shortcuts</h3>
        <div class="shortcuts-list">
          <div class="shortcuts-list__item">
            <span class="shortcuts-list__action">Navigate images</span>
            <div class="shortcuts-list__keys">
              <span class="kbd">‚Üê</span>
              <span class="kbd">‚Üí</span>
            </div>
          </div>
          <div class="shortcuts-list__item">
            <span class="shortcuts-list__action">Close modal / Exit mode</span>
            <div class="shortcuts-list__keys">
              <span class="kbd">Esc</span>
            </div>
          </div>
          <div class="shortcuts-list__item">
            <span class="shortcuts-list__action">Pick left (comparison)</span>
            <div class="shortcuts-list__keys">
              <span class="kbd">‚Üê</span>
              <span class="kbd">1</span>
            </div>
          </div>
          <div class="shortcuts-list__item">
            <span class="shortcuts-list__action">Pick right (comparison)</span>
            <div class="shortcuts-list__keys">
              <span class="kbd">‚Üí</span>
              <span class="kbd">2</span>
            </div>
          </div>
          <div class="shortcuts-list__item">
            <span class="shortcuts-list__action">Skip / Tie (comparison)</span>
            <div class="shortcuts-list__keys">
              <span class="kbd">Space</span>
              <span class="kbd">S</span>
            </div>
          </div>
          <div class="shortcuts-list__item">
            <span class="shortcuts-list__action">Toggle slideshow</span>
            <div class="shortcuts-list__keys">
              <span class="kbd">P</span>
            </div>
          </div>
          <div class="shortcuts-list__item">
            <span class="shortcuts-list__action">Show this help</span>
            <div class="shortcuts-list__keys">
              <span class="kbd">?</span>
            </div>
          </div>
        </div>
        <div class="shortcuts-modal__actions">
          <button id="close-shortcuts" class="ghost">Close</button>
        </div>
      </div>
    </div>

    <!-- Duplicate Warning Modal -->
    <div id="duplicate-modal" class="duplicate-modal" hidden>
      <div class="duplicate-modal__backdrop"></div>
      <div class="duplicate-modal__content">
        <h3>‚ö†Ô∏è Duplicate Files Detected</h3>
        <p>Some files you're uploading already exist in this project:</p>
        <div id="duplicate-list" class="duplicate-list"></div>
        <div class="duplicate-modal__actions">
          <button id="upload-skip-duplicates" class="primary">Skip Duplicates</button>
          <button id="upload-all-anyway" class="ghost">Upload All</button>
          <button id="cancel-upload" class="ghost">Cancel</button>
        </div>
      </div>
    </div>

    <!-- Loading Overlay for Gallery -->
    <div id="gallery-loading" class="loading-overlay" hidden>
      <div class="spinner spinner--large"></div>
    </div>

    <!-- Dropdown Backdrop (for mobile tap-to-close) -->
    <div id="dropdown-backdrop" class="dropdown-backdrop" hidden></div>

    <script src="{{ url_for('static', filename='app.js') }}" defer></script>
    <script>
      // Register Service Worker for PWA
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(err => console.log('SW registration failed:', err));
      }
    </script>
  </body>
</html>
